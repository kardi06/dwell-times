# Story 1.11: Waiting Time Analytics

## Status
Approved

## Story
**As a** user of the Dwell-Insight analytics platform,
**I want to** visualize and analyze waiting time patterns for people waiting more than 10 minutes,
**so that** I can identify peak waiting periods and optimize resource allocation.

## Acceptance Criteria

1. **Database Enhancement:**
   - [ ] Add `camera_group` column to `camera_events` table
   - [ ] Migrate existing data to populate camera groups
   - [ ] Create appropriate indexes for performance

2. **Backend API Development:**
   - [ ] Create endpoint for waiting time analytics data
   - [ ] Filter data for dwell_time > 10 minutes
   - [ ] Group data by hour/day and camera information
   - [ ] Implement camera and time period filtering
   - [ ] Optimize query performance for large datasets

3. **Chart Component Development:**
   - [ ] Create WaitingTimeChart component using Chart.js
   - [ ] Display number of people (y-axis) vs time periods (x-axis)
   - [ ] Implement interactive tooltips with detailed information
   - [ ] Support switching between hourly and daily views
   - [ ] Handle loading and error states gracefully

4. **Filtering & Controls:**
   - [ ] Add camera selection dropdown (default: all cameras)
   - [ ] Create time period selector (hour/day toggle)
   - [ ] Implement date range selection
   - [ ] Add export functionality for chart data

5. **Integration & Performance:**
   - [ ] Integrate with existing dashboard layout
   - [ ] Implement real-time data updates
   - [ ] Optimize data fetching and rendering
   - [ ] Handle large datasets efficiently

## Tasks / Subtasks

- [x] **Task 1: Database Enhancement (AC: 1)**
  - [x] Create database migration script:
    ```sql
    ALTER TABLE camera_events
    ADD COLUMN camera_group VARCHAR(100);
    
    CREATE INDEX idx_camera_events_waiting_time 
    ON camera_events(dwell_time, camera_group, camera_description);
    ```
  - [x] Implement data migration logic
  - [x] Add database model updates
  - [x] Test migration with sample data

- [x] **Task 2: Backend API Development (AC: 2)**
  - [x] Create new endpoint `/api/v1/analytics/waiting-time`
  - [x] Implement data aggregation logic:
    ```python
    # Pseudo-code for aggregation
    SELECT 
      date_trunc('hour', utc_time_started_readable) as time_period,
      camera_group,
      camera_description,
      COUNT(DISTINCT person_id) as waiting_count
    FROM camera_events
    WHERE dwell_time > 600  # More than 10 minutes in seconds
    GROUP BY time_period, camera_group, camera_description
    ```
  - [x] Add filtering parameters (time period, camera selection)
  - [x] Implement caching for performance
  - [x] Add API documentation

- [ ] **Task 3: Chart Component Development (AC: 3)**
  - [ ] Create new `WaitingTimeChart` component
  - [ ] Implement Chart.js line chart configuration
  - [ ] Add custom tooltip component
  - [ ] Create time period switching logic
  - [ ] Add loading and error states

- [ ] **Task 4: Filtering Controls (AC: 4)**
  - [ ] Create camera selector component
  - [ ] Implement time period toggle (hour/day)
  - [ ] Add date range picker integration
  - [ ] Create data export functionality

- [ ] **Task 5: Dashboard Integration (AC: 5)**
  - [ ] Add chart to dashboard layout
  - [ ] Implement real-time updates
  - [ ] Add performance optimizations
  - [ ] Create comprehensive tests

## Dev Notes

### API Specification

**Endpoint:** `/api/v1/analytics/waiting-time`

**Query Parameters:**
- `view_type`: 'hourly' | 'daily'
- `start_date`: ISO date string
- `end_date`: ISO date string
- `camera_ids`: string[] (optional)
- `camera_groups`: string[] (optional)

**Response Format:**
```typescript
interface WaitingTimeData {
  time_period: string;
  waiting_count: number;
  camera_info: {
    camera_description: string;
    camera_group: string;
  };
}

interface WaitingTimeResponse {
  data: WaitingTimeData[];
  metadata: {
    total_records: number;
    filtered_records: number;
    time_range: {
      start: string;
      end: string;
    };
  };
}
```

### Component Interface

```typescript
interface WaitingTimeChartProps {
  data: WaitingTimeData[];
  viewType: 'hourly' | 'daily';
  onViewTypeChange: (type: 'hourly' | 'daily') => void;
  selectedCameras: string[];
  onCameraChange: (cameras: string[]) => void;
  isLoading: boolean;
  error?: Error;
}

interface WaitingTimeFilterProps {
  cameras: Array<{
    id: string;
    description: string;
    group: string;
  }>;
  selectedCameras: string[];
  onCameraChange: (cameras: string[]) => void;
  viewType: 'hourly' | 'daily';
  onViewTypeChange: (type: 'hourly' | 'daily') => void;
  dateRange: [Date, Date];
  onDateRangeChange: (range: [Date, Date]) => void;
}
```

### Chart Configuration

```typescript
const chartConfig = {
  type: 'line',
  data: {
    datasets: [{
      label: 'Waiting People',
      borderColor: '#36A2EB',
      fill: false,
      tension: 0.4
    }]
  },
  options: {
    responsive: true,
    interaction: {
      intersect: false,
      mode: 'index'
    },
    scales: {
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: 'Number of People Waiting'
        }
      },
      x: {
        type: 'time',
        time: {
          unit: viewType === 'hourly' ? 'hour' : 'day'
        },
        title: {
          display: true,
          text: 'Time Period'
        }
      }
    },
    plugins: {
      tooltip: {
        enabled: true,
        callbacks: {
          label: (context) => {
            return `Waiting: ${context.parsed.y} people`;
          }
        }
      }
    }
  }
};
```

### Performance Considerations

1. **Database:**
   - Indexed queries for efficient filtering
   - Materialized views for common aggregations
   - Partitioning for historical data

2. **API:**
   - Response caching with Redis
   - Pagination for large datasets
   - Aggregated data pre-calculation

3. **Frontend:**
   - Debounced filter updates
   - Virtualized camera selection list
   - Memoized chart rendering
   - Progressive loading for historical data

### Testing Strategy

1. **Unit Tests:**
   - Chart component rendering
   - Filter interactions
   - Data transformations

2. **Integration Tests:**
   - API endpoint functionality
   - Data flow through components
   - Filter combinations

3. **Performance Tests:**
   - Large dataset handling
   - Real-time update performance
   - Cache effectiveness

## Dependencies
- Chart.js and react-chartjs-2
- Date handling libraries (date-fns)
- Redis for caching
- Database migration tools

## Testing
- Unit tests for components and data processing
- Integration tests for API endpoints
- Performance testing with large datasets
- Browser compatibility testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-30 | 1.0 | Initial story creation | SM |
| 2024-01-30 | 1.1 | Task 2 completed - Backend API Development | Dev |

## Dev Agent Record

### Agent Model Used
- **Agent**: James (Full Stack Developer)
- **Mode**: Development Implementation
- **Focus**: Backend API Development for Waiting Time Analytics

### Debug Log References
- Created migration: `backend/alembic/versions/add_camera_group_column_migration.py`
- Updated model: `backend/app/models/camera_events.py` - Added camera_group column
- Created endpoint: `backend/app/api/analytics/waiting_time_analytics.py`
- Updated router: `backend/app/api/analytics/router.py` - Added waiting time router
- Created tests: `backend/tests/unit/test_waiting_time_analytics.py`
- Created validation: `backend/validate_waiting_time_implementation.py`

### Completion Notes List
1. **Database Enhancement**: 
   - ✅ Added `camera_group` column to `camera_events` table
   - ✅ Created migration script with proper indexing
   - ✅ Updated CameraEvent model with camera_group field

2. **Backend API Development**:
   - ✅ Created `/api/v1/analytics/waiting-time` endpoint
   - ✅ Implemented filtering for dwell_time > 10 minutes (600 seconds)
   - ✅ Added support for hourly/daily view types
   - ✅ Implemented date range filtering
   - ✅ Added camera ID and camera group filtering
   - ✅ Created comprehensive unit tests
   - ✅ Added proper error handling and validation

3. **API Features Implemented**:
   - ✅ Query parameters: view_type, start_date, end_date, camera_ids, camera_groups
   - ✅ Response format matches API specification
   - ✅ Proper metadata with total records and time range
   - ✅ Optimized queries with database indexes

### File List
**New Files Created:**
- `backend/alembic/versions/add_camera_group_column_migration.py`
- `backend/app/api/analytics/waiting_time_analytics.py`
- `backend/tests/unit/test_waiting_time_analytics.py`
- `backend/validate_waiting_time_implementation.py`
- `backend/test_waiting_time_api.py`

**Modified Files:**
- `backend/app/models/camera_events.py` - Added camera_group column
- `backend/app/api/analytics/router.py` - Added waiting time router import and inclusion

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-01-30 | 1.0 | Initial story creation | SM |
| 2024-01-30 | 1.1 | Task 2 completed - Backend API Development | Dev | 