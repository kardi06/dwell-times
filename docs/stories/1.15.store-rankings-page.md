# Story 1.15: Store Rankings Page (COO Performance Insights)

## Status
Approved

## Story
**As a** COO,
**I want** a rankings page that shows top/bottom stores by key operational metrics,
**so that** I can quickly detect issues, identify best practices, and improve store performance at scale.

## Global Filters (top of page)
- Division → `camera_events.division`
- Department → `camera_events.department`
- Time period + Date (same UX as Dashboard/ChartFilters)
- Optional: Store pre-filter (defaults All) for drill-ins

These global filters apply to every widget on this page (rankings + drill-down). They combine with any local options within widgets.

## Metrics & Definitions (per Store = `camera_group`)
- **Daily Visitors (per store, per day)**: count each `person_id` once per store per calendar day.
- **Visitors Over Period**: `COUNT(DISTINCT (person_id, camera_group, DATE(utc_time_started_readable)))` summed over the selected period for that store.
- **Repeat Visitors (per store)**: persons who visited the same store on **2+ distinct days** in the selected period.
- **Total Dwell Time**: `SUM(dwell_time)` (seconds) for that store and period.
- **Average Dwell Time**: `AVG(dwell_time)` for that store and period.
- **Waiting Violations**: `COUNT(DISTINCT person_id)` where `dwell_time > 600` seconds (10 minutes) per store and period.
- **Momentum (Visitors)**: change vs previous period (Δ visitors_over_period or %).
- **Underperformers (Trend)**: largest negative change vs previous period (visitors and/or avg dwell).

Notes
- If a person visits multiple stores in a day, they are counted once in each store’s **daily** visitors.
- Multiple events in the same store/day from the same person count once toward daily visitors.

## Rankings to Show (Top/Bottom N with 5/10 toggle)
1. Top 5 Stores by Visitors
2. Top 5 Stores by Total Dwell Time
3. Bottom 5 Stores by Visitors
4. Bottom 5 Stores by Average Dwell Time (minimum)
5. Top 5 Stores by Waiting Violations (>10m)
6. Top 5 Stores by Repeat Visitor Rate
7. Momentum Winners (highest positive Δ visitors vs previous period)
8. Underperformers (largest negative Δ visitors vs previous period)

Each ranking widget displays:
- Horizontal bar chart + small sortable table (Store, Division, Department, Metric, Δ vs previous)
- Tooltip with metric explanation; color cues (green ↑, red ↓)
- Click row → DrillDown drawer (store profile) with hourly/daily trend, camera list, violations trend

## Backend
### Endpoints
- `GET /api/v1/analytics/store-rankings`
  - Query:
    - `metric`: `visitors|dwell_total|dwell_avg|wait_10m|repeat_rate|momentum|underperformers`
    - `order`: `desc|asc` (default by metric meaning; bottom lists use `asc`)
    - `limit`: `5|10`
    - `division`, `department`, `start_date`, `end_date`
  - Response (generic):
    ```json
    {
      "metric": "visitors",
      "rows": [
        {
          "store": "Plaza A",
          "division": "Fashion",
          "department": "Men",
          "value": 1234,
          "delta": 0.12  // compared to previous period
        }
      ]
    }
    ```

- `GET /api/v1/analytics/store-profile?store=...&start_date=...&end_date=...`
  - Returns drill-down payload for the drawer: hourly/daily series, dwell distributions, violations series, camera list.

### SQL Patterns (PostgreSQL)
- Visitors Over Period by store:
  ```sql
  SELECT
    camera_group AS store,
    COUNT(DISTINCT (person_id, camera_group, DATE(utc_time_started_readable))) AS visitors_over_period
  FROM camera_events
  WHERE utc_time_started_readable BETWEEN :start AND :end
    AND (:division IS NULL OR division = :division)
    AND (:department IS NULL OR department = :department)
  GROUP BY store
  ORDER BY visitors_over_period DESC
  LIMIT :limit;
  ```

- Repeat Visitors (≥2 days):
  ```sql
  WITH per_day AS (
    SELECT DISTINCT person_id, camera_group AS store, DATE(utc_time_started_readable) AS visit_date
    FROM camera_events
    WHERE utc_time_started_readable BETWEEN :start AND :end
      AND (:division IS NULL OR division = :division)
      AND (:department IS NULL OR department = :department)
  ), repeaters AS (
    SELECT store, person_id
    FROM per_day
    GROUP BY store, person_id
    HAVING COUNT(DISTINCT visit_date) >= 2
  )
  SELECT store, COUNT(*) AS repeat_visitors
  FROM repeaters
  GROUP BY store
  ORDER BY repeat_visitors DESC
  LIMIT :limit;
  ```

- Waiting Violations (>600s):
  ```sql
  SELECT camera_group AS store, COUNT(DISTINCT person_id) AS wait_violations
  FROM camera_events
  WHERE dwell_time > 600
    AND utc_time_started_readable BETWEEN :start AND :end
    AND (:division IS NULL OR division = :division)
    AND (:department IS NULL OR department = :department)
  GROUP BY store
  ORDER BY wait_violations DESC
  LIMIT :limit;
  ```

- Momentum / Underperformers: compute current and previous period in one CTE and order by delta.

Indexes used: `idx_group_dept_div`, `idx_department`, `idx_division`, `idx_created_at_analytics`, `idx_dwell_time_analytics`.

## Frontend
### Page: `StoreRankingsPage`
- Reuse `GlobalFilterBar` (Division, Department, TimePeriod/Date)
- RankingGrid: 8 cards (responsive 1/2/4 columns)
- Each card: horizontal bar chart (Chart.js) + compact table; toggle Top 5 / Top 10
- DrillDownDrawer: opens on row click → store profile mini-dashboard
- Actions: Export CSV (visible rows), Download PNG for chart

### Visual/UX
- Clean layout, clear hierarchy, delightful tooltips
- Color-coded deltas (green positive, red negative) with ▲▼ glyphs
- Skeleton loaders; disabled interactions during load; accessible labels

## Tasks / Subtasks
- [ ] Backend: implement `/store-rankings` endpoint and metrics; add `/store-profile` drill‑down
- [ ] Frontend: build `StoreRankingsPage` + RankingCard + DrillDownDrawer components
- [ ] Integrate GlobalFilterBar and date logic
- [ ] Wire navigation (sidebar/link) and deep-linking from Dashboard
- [ ] Tests: unit (SQL/service), integration (API), E2E (page interactions)
- [ ] Docs: endpoint descriptions, metric definitions, “how to read” help

## Non‑Goals (for now)
- Brand/product filter (future when data available)
- Per-store revenue links (no POS integration yet)

## Change Log
| Date       | Version | Description                         | Author |
|------------|---------|-------------------------------------|--------|
| 2025-01-30 | 1.0     | Initial story for Store Rankings    | SM     |
