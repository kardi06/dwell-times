# Story 1.9: Analytics API Refactoring

## Status
Ready for Review

## Story
**As a** developer working on the Dwell-Insight analytics platform,
**I want to** refactor the large analytics.py file into multiple smaller, focused files,
**so that** the codebase becomes more maintainable, testable, and easier to understand.

## Acceptance Criteria
1. **File Division:**
   - [ ] Split analytics.py (1066 lines) into 8 focused modules
   - [ ] Maintain all existing API endpoints without breaking changes
   - [ ] Keep main analytics.py as a router that imports sub-routers
   - [ ] Each sub-module handles a specific domain of analytics

2. **Module Organization:**
   - [ ] **File Upload & Processing** (`upload_analytics.py`)
   - [ ] **KPI & Basic Analytics** (`kpi_analytics.py`)
   - [ ] **Occupancy Analytics** (`occupancy_analytics.py`)
   - [ ] **Dwell Time Analytics** (`dwell_time_analytics.py`)
   - [ ] **Event Management** (`event_analytics.py`)
   - [ ] **Demographic Analytics** (`demographic_analytics.py`)
   - [ ] **Chart Data** (`chart_analytics.py`)
   - [ ] **Camera Management** (`camera_analytics.py`)

3. **Router Integration:**
   - [ ] Main analytics.py becomes a router that includes all sub-routers
   - [ ] All existing endpoints maintain their exact paths and functionality
   - [ ] No changes required in frontend or other consuming services
   - [ ] Proper error handling and logging maintained across all modules

4. **Code Quality:**
   - [ ] Each module has focused responsibility and clear purpose
   - [ ] Consistent import structure and dependency management
   - [ ] Maintain existing error handling patterns
   - [ ] Keep all existing logging and debugging functionality

5. **Documentation:**
   - [ ] Update module docstrings to reflect new organization
   - [ ] Maintain existing endpoint documentation
   - [ ] Add clear module-level documentation

## Tasks / Subtasks
- [x] **Task 1: Create File Upload & Processing Module (AC: 1, 2)**
  - [x] Create `backend/app/api/analytics/upload_analytics.py`
  - [x] Move `/upload-csv` and `/calculate-dwell-times` endpoints
  - [x] Include all related imports and dependencies
  - [x] Maintain existing error handling and validation

- [x] **Task 2: Create KPI & Basic Analytics Module (AC: 1, 2)**
  - [x] Create `backend/app/api/analytics/kpi_analytics.py`
  - [x] Move `/kpi-metrics` and `/comprehensive-analytics` endpoints
  - [x] Include AnalyticsService imports and dependencies
  - [x] Maintain existing date parsing and validation logic

- [x] **Task 3: Create Occupancy Analytics Module (AC: 1, 2)**
  - [x] Create `backend/app/api/analytics/occupancy_analytics.py`
  - [x] Move `/occupancy-analytics` endpoint
  - [x] Include time period validation and AnalyticsService dependencies
  - [x] Maintain existing parameter validation

- [x] **Task 4: Create Dwell Time Analytics Module (AC: 1, 2)**
  - [x] Create `backend/app/api/analytics/dwell_time_analytics.py`
  - [x] Move `/dwell-time-analytics` and `/aggregated-dwell-time` endpoints
  - [x] Include DwellTimeEngine imports and dependencies
  - [x] Maintain existing group_by validation and processing logic

- [x] **Task 5: Create Event Management Module (AC: 1, 2)**
  - [x] Create `backend/app/api/analytics/event_analytics.py`
  - [x] Move `/events` endpoint (the large aggregated events endpoint)
  - [x] Include all complex filtering, sorting, and pagination logic
  - [x] Maintain existing debug logging and data formatting functions

- [x] **Task 6: Create Demographic Analytics Module (AC: 1, 2)**
  - [x] Create `backend/app/api/analytics/demographic_analytics.py`
  - [x] Move `/demographic-insights` and `/demographic-distribution` endpoints
  - [x] Include demographic grouping and aggregation logic
  - [x] Maintain existing null value handling for gender/age groups

- [x] **Task 7: Create Chart Data Module (AC: 1, 2)**
  - [x] Create `backend/app/api/analytics/chart_analytics.py`
  - [x] Move `/chart-data` and `/foot-traffic-data` endpoints
  - [x] Include chart data aggregation and formatting logic
  - [x] Maintain existing time period and metric type handling

- [x] **Task 8: Create Camera Management Module (AC: 1, 2)**
  - [x] Create `backend/app/api/analytics/camera_analytics.py`
  - [x] Move `/cameras` endpoint
  - [x] Include camera list querying and filtering logic
  - [x] Maintain existing distinct query functionality

- [x] **Task 9: Refactor Main Analytics Router (AC: 3)**
  - [x] Create `backend/app/api/analytics/router.py` as main router
  - [x] Import and include all sub-routers
  - [x] Maintain existing router prefix and tags
  - [x] Ensure all endpoints are properly registered

- [x] **Task 10: Update Imports and Dependencies (AC: 4)**
  - [x] Update all import statements in new modules
  - [x] Ensure consistent dependency management
  - [x] Maintain existing error handling patterns
  - [x] Update main.py to use new analytics router

- [x] **Task 11: Documentation and Testing Preparation (AC: 5)**
  - [x] Add module-level docstrings to all new files
  - [x] Update existing endpoint documentation
  - [x] Ensure all logging statements are preserved
  - [x] Prepare structure for future focused testing

## Dev Notes

### File Structure
**New Directory Structure:**
```
backend/app/api/analytics/
├── __init__.py
├── upload_analytics.py          # File upload and processing
├── kpi_analytics.py            # KPI and basic analytics
├── occupancy_analytics.py       # Occupancy analytics
├── dwell_time_analytics.py      # Dwell time analytics
├── event_analytics.py          # Event management (largest module)
├── demographic_analytics.py     # Demographic analytics
├── chart_analytics.py          # Chart data endpoints
├── camera_analytics.py         # Camera management
└── router.py                   # Main router (renamed from analytics.py)
```

### Module Responsibilities

**1. upload_analytics.py:**
- `/upload-csv` - CSV file upload and processing
- `/calculate-dwell-times` - Manual dwell time calculation
- Dependencies: CSVProcessor, DwellTimeEngine, AnalyticsService

**2. kpi_analytics.py:**
- `/kpi-metrics` - KPI metrics retrieval
- `/comprehensive-analytics` - Comprehensive analytics
- Dependencies: AnalyticsService

**3. occupancy_analytics.py:**
- `/occupancy-analytics` - Occupancy analytics by time periods
- Dependencies: AnalyticsService

**4. dwell_time_analytics.py:**
- `/dwell-time-analytics` - Dwell time analytics grouped by dimension
- `/aggregated-dwell-time` - Aggregated dwell time statistics
- Dependencies: DwellTimeEngine

**5. event_analytics.py:**
- `/events` - Aggregated events with complex filtering
- Dependencies: CameraEvent model, complex SQL queries

**6. demographic_analytics.py:**
- `/demographic-insights` - Demographic insights and analytics
- `/demographic-distribution` - Demographic distribution analytics
- Dependencies: CameraEvent model, demographic grouping

**7. chart_analytics.py:**
- `/chart-data` - Chart data for dwell time analytics
- `/foot-traffic-data` - Foot traffic analytics data
- Dependencies: CameraEvent model, chart data aggregation

**8. camera_analytics.py:**
- `/cameras` - List of available camera descriptions
- Dependencies: CameraEvent model

### Router Integration
**Main Router (router.py):**
```python
from fastapi import APIRouter
from .upload_analytics import router as upload_router
from .kpi_analytics import router as kpi_router
from .occupancy_analytics import router as occupancy_router
from .dwell_time_analytics import router as dwell_router
from .event_analytics import router as event_router
from .demographic_analytics import router as demographic_router
from .chart_analytics import router as chart_router
from .camera_analytics import router as camera_router

router = APIRouter(prefix="/api/v1/analytics", tags=["analytics"])

# Include all sub-routers
router.include_router(upload_router)
router.include_router(kpi_router)
router.include_router(occupancy_router)
router.include_router(dwell_router)
router.include_router(event_router)
router.include_router(demographic_router)
router.include_router(chart_router)
router.include_router(camera_router)
```

### Import Structure
**Each module will have consistent imports:**
```python
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from sqlalchemy import func, extract
from typing import Optional
from datetime import datetime, timedelta
import logging

from ...core.database import get_db
from ...models.camera_events import CameraEvent
from ...services.analytics_service import AnalyticsService
from ...core.exceptions import DataValidationError, ProcessingError, AnalyticsError

logger = logging.getLogger(__name__)

router = APIRouter()
```

### Error Handling
- Maintain all existing error handling patterns
- Keep HTTPException status codes consistent
- Preserve all logging statements
- Maintain existing validation logic

### Testing Preparation
- Each module will be independently testable
- Structure allows for focused unit tests per module
- Integration tests can test the main router
- Mock dependencies can be easily injected

### Migration Strategy
1. Create new modules one by one
2. Test each module independently
3. Update main router to include new modules
4. Verify all endpoints work correctly
5. Remove old analytics.py file
6. Update any import references

## Testing
- Unit tests for each module (future task)
- Integration tests for main router
- End-to-end tests for all endpoints
- Performance tests for large queries

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Initial story creation | SM |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- None yet

### Completion Notes List
- Successfully refactored the large analytics.py file (1066 lines) into 8 focused modules
- Each module has clear responsibility and focused purpose
- All existing endpoints maintain their exact paths and functionality
- Maintained all existing error handling patterns and logging
- Updated main.py to use the new modular analytics router
- All modules include proper docstrings and documentation
- Structure allows for independent testing of each module
- No breaking changes to the API interface

### File List
- `backend/app/api/analytics/__init__.py` - Package initialization
- `backend/app/api/analytics/router.py` - Main analytics router
- `backend/app/api/analytics/upload_analytics.py` - File upload and processing endpoints
- `backend/app/api/analytics/kpi_analytics.py` - KPI and basic analytics endpoints
- `backend/app/api/analytics/occupancy_analytics.py` - Occupancy analytics endpoint
- `backend/app/api/analytics/dwell_time_analytics.py` - Dwell time analytics endpoints
- `backend/app/api/analytics/event_analytics.py` - Event management endpoints
- `backend/app/api/analytics/demographic_analytics.py` - Demographic analytics endpoints
- `backend/app/api/analytics/chart_analytics.py` - Chart data endpoints
- `backend/app/api/analytics/camera_analytics.py` - Camera management endpoint
- `backend/app/main.py` - Updated to use new analytics router 