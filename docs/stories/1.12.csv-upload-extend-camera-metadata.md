# Story 1.12: Extend CSV Upload to Capture Camera Group, Department, Division

## Status
Ready for Review

## Story
**As a** data operator,
**I want to** upload CSV files that include camera grouping metadata (group, department, division),
**so that** the platform stores richer context for analytics and filtering without manual enrichment.

## Acceptance Criteria
1. **CSV Columns to Support (input → stored field):**
   - `camera_group_data_group_name` → `camera_group`
   - `camera_group_data_group_departemen` → `department`
   - `camera_group_data_group_divisi` → `division`
2. **Backward compatible:** Upload succeeds even if these columns are missing; stored fields default to NULL.
3. **Validation:**
   - If present, trim whitespace; normalize empty strings to NULL.
   - Max length 100 chars; values longer than 100 are truncated with a warning in logs.
4. **Persistence:** Values are written to `camera_events.camera_group`, `camera_events.department`, `camera_events.division` for every ingested row.
5. **Observability:**
   - Upload response includes a short summary of how many rows had each of the three fields populated.
   - Warnings collected for truncated values and unknown header names that look similar.
6. **Docs & Template:** Update sample CSV template and API docs to list the three new optional columns.
7. **Tests:** Unit tests for parsing, normalization, and persistence; integration test for upload endpoint with and without the new columns.

## Tasks / Subtasks
- [x] **Task 1: Parsing & Mapping (backend/app/services/csv_processor.py)**
  - [x] Add a header → model mapping dictionary:
    ```python
    COLUMN_ALIASES = {
      'camera_group_data_group_name': 'camera_group',
      'camera_group_data_group_departemen': 'department',
      'camera_group_data_group_divisi': 'division',
    }
    ```
  - [x] During row parsing, copy and normalize values using the aliases; trim, convert "" to None; enforce 100-char max.
  - [x] Collect ingestion stats (counts per field) and warnings (truncations, unknown headers).

- [x] **Task 2: Persistence (models already updated)**
  - [x] Ensure mapped values are included in the ORM payload for `CameraEvent` creation.
  - [x] Confirm indexes exist for `camera_group`, `department`, `division` (see model).

- [x] **Task 3: API Response (backend upload endpoint)**
  - [x] Extend upload response JSON with:
    ```json
    {
      "ingestionSummary": {
        "camera_group_populated": 1234,
        "department_populated": 1200,
        "division_populated": 1188
      },
      "warnings": ["department value truncated on 3 rows", "unknown header cam_group mapped via alias"]
    }
    ```

- [x] **Task 4: Validation & Error Handling**
  - [x] Non-blocking: missing columns do not fail the upload.
  - [x] Blocking only on invalid CSV format; log and continue on per-row anomalies.

- [ ] **Task 5: Documentation**
  - [ ] Update CSV template and README/API docs to include the three optional columns and their meanings.

- [ ] **Task 6: Testing**
  - [ ] Unit tests for parser normalization and length enforcement.
  - [ ] Unit test for alias mapping.
  - [ ] Integration tests for upload endpoint with: (a) all three columns present; (b) none present; (c) mixed presence and over-length values.

## Dev Notes
- Database schema & model already support these fields (`camera_group`, `department`, `division`).
- Keep mapping logic centralized so future aliases can be added without touching core parsing.
- Prefer streaming/iterator-based parsing to avoid memory spikes on large CSVs.

## API / Contract Notes
- No request shape change; columns are optional.
- Response gains `ingestionSummary` and `warnings` fields as non-breaking additions.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-30 | 1.0 | Initial story creation | SM |
