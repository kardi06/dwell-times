# Story 1.6: Enhanced Analytics with Demographics

## Status
Ready for Review

## Story
**As a** user of the Dwell-Insight analytics platform,
**I want to** analyze camera event data with demographic information (age group and gender) and view dwell time patterns grouped by time periods,
**so that** I can understand visitor behavior patterns across different demographics and time periods.

## Acceptance Criteria
1. **Database Schema Enhancement:**
   - [ ] Add age_group_outcome column to camera_events table (VARCHAR, nullable)
   - [ ] Add gender_outcome column to camera_events table (VARCHAR, nullable)
   - [ ] Update zone_name column to be nullable (already nullable based on existing schema)
   - [ ] Handle null/undefined values as "other" for both demographic fields

2. **CSV Data Processing Enhancement:**
   - [ ] Parse age_group_outcome and gender_outcome from CSV data
   - [ ] Map null/undefined values to "other" during processing
   - [ ] Store demographic data in camera_events table
   - [ ] Maintain existing dwell time calculation logic

3. **EventTable Redesign with New Grouping:**
   - [ ] Group data by: person_id, time_period (1-hour intervals), gender, age_group
   - [ ] Display columns: person_id, time_period, gender, age_group, total_dwell_time, event_count
   - [ ] Time periods format: "01:00 PM - 02:00 PM" (hourly intervals)
   - [ ] Handle null values as "other" in display

4. **Enhanced Search and Filtering:**
   - [ ] Search by person_id (text input)
   - [ ] Filter by gender (dropdown select)
   - [ ] Filter by age_group (dropdown select)
   - [ ] Filter by time period (hourly intervals)
   - [ ] Combine multiple filters

5. **Analytics and Aggregation:**
   - [ ] Calculate total_dwell_time and event_count per person per time period per demographic
   - [ ] Support filtering by all demographic and time criteria
   - [ ] Update KPI cards to show demographic-based analytics
   - [ ] Optimize queries for new grouping structure

## Tasks / Subtasks
- [x] **Task 1: Database Schema Updates (AC: 1)**
  - [x] Add age_group_outcome column to camera_events table
  - [x] Add gender_outcome column to camera_events table
  - [x] Verify zone_name is nullable
  - [x] Add indexes for new demographic columns
  - [x] Update existing indexes for new grouping queries

- [x] **Task 2: CSV Processing Enhancement (AC: 2)**
  - [x] Update CSV parser to extract age_group_outcome and gender_outcome
  - [x] Implement null/undefined to "other" mapping logic
  - [x] Update dwell time calculation to include demographic data
  - [x] Enhance data validation for new fields
  - [x] Update bulk insert operations with demographic fields

- [x] **Task 3: Backend API Enhancement (AC: 2, 5)**
  - [x] Update events endpoint for new grouping: person_id, time_period, gender, age_group
  - [x] Add time period calculation logic (hourly intervals)
  - [x] Implement demographic-based filtering endpoints
  - [x] Add analytics endpoints for demographic insights
  - [x] Optimize queries for new grouping structure

- [x] **Task 4: EventTable Component Redesign (AC: 3)**
  - [x] Update CameraEvent interface for new grouping structure
  - [x] Redesign table columns for time periods and demographics
  - [x] Implement time period formatting (hourly intervals)
  - [x] Add demographic display with "other" handling
  - [x] Update CSV export for new column structure

- [x] **Task 5: Enhanced Search and Filtering (AC: 4)**
  - [x] Add person_id search functionality
  - [x] Implement gender dropdown filter using react-select
  - [x] Implement age_group dropdown filter using react-select
  - [x] Add time period filter (hourly intervals)
  - [x] Combine multiple filters with AND logic

- [x] **Task 6: Analytics Integration (AC: 5)**
  - [x] Create SQL GROUP BY queries for new grouping structure
  - [x] Update KPI cards for demographic-based analytics
  - [x] Add demographic distribution analytics
  - [x] Implement time-based analytics with hourly grouping

## Dev Notes

### Previous Story Insights
- Story 1.5 provides the foundation for CSV processing and EventTable integration
- Current EventTable shows aggregated data by person_id and camera_description
- Need to extend with demographic data and time-based grouping
- Existing dwell time calculation logic should be preserved

### Data Models
**CameraEvent Interface (Updated for Demographic Grouping):**
```typescript
interface CameraEvent {
  person_id: string;
  time_period: string; // e.g., "01:00 PM - 02:00 PM"
  gender: string; // "male", "female", "other"
  age_group: string; // "20-29", "30-39", "other"
  total_dwell_time: number; // in seconds, pre-calculated
  event_count: number; // number of events for this group
  created_at: string; // ISO timestamp of latest event
}
```

**CSV Data Structure (Enhanced):**
- person_id: string (e.g., "cid:51887-9160-4baf-b99c-dce2c15493e8")
- camera_id: string (e.g., "961db544-5f2f-4d12-8087-a5b22c7183")
- camera_description: string (e.g., "Video 1")
- zone_name: string (nullable, e.g., "Cashier queue")
- utc_time_started_readable: string (e.g., "7/28/2025 9:55")
- utc_time_ended_readable: string (e.g., "7/28/2025 9:56")
- age_group_outcome: string (e.g., "20-29", "30-39", null → "other")
- gender_outcome: string (e.g., "male", "female", null → "other")

**Time Period Calculation:**
- Group events by 1-hour intervals based on utc_time_started_readable
- Format: "01:00 PM - 02:00 PM" (start hour to end hour)
- Handle timezone conversion properly

### API Specifications
**Enhanced Events Retrieval Endpoint:**
- `GET /api/v1/analytics/events`
- Query parameters: page, limit, person_id, gender, age_group, time_period
- Returns events grouped by: person_id, time_period, gender, age_group
- Supports filtering by all demographic and time criteria

**Demographic Analytics Endpoint:**
- `GET /api/v1/analytics/demographic-insights`
- Query parameters: time_period, gender, age_group
- Returns demographic distribution and dwell time analytics
- Fast queries using indexes on demographic columns

### Component Specifications
**EventTable Component Redesign:**
- Location: `frontend/src/components/Dashboard/EventTable.tsx`
- Props: `token: string`
- New columns: person_id, time_period, gender, age_group, total_dwell_time, event_count
- Enhanced filtering with react-select dropdowns
- Time period formatting and display
- Demographic data handling with "other" fallback

**Search and Filter Components:**
- Person ID search: Text input with debounced search
- Gender filter: react-select dropdown with options: "male", "female", "other"
- Age group filter: react-select dropdown with options: "20-29", "30-39", "40-49", "other"
- Time period filter: react-select dropdown with hourly intervals

### Database Schema Changes (Step by Step)

**Step 1: Add Demographic Columns**
```sql
-- Add age_group_outcome column
ALTER TABLE camera_events 
ADD COLUMN age_group_outcome VARCHAR(50);

-- Add gender_outcome column  
ALTER TABLE camera_events 
ADD COLUMN gender_outcome VARCHAR(20);

-- Verify zone_name is nullable (should already be nullable)
-- No action needed if already nullable
```

**Step 2: Add Indexes for Performance**
```sql
-- Add indexes for new demographic columns
CREATE INDEX idx_camera_events_age_group_outcome ON camera_events(age_group_outcome);
CREATE INDEX idx_camera_events_gender_outcome ON camera_events(gender_outcome);

-- Composite index for new grouping queries
CREATE INDEX idx_camera_events_demographic_grouping ON camera_events(person_id, age_group_outcome, gender_outcome, created_at);
```

**Step 3: Update Existing Data (if needed)**
```sql
-- Update null values to "other" for existing data
UPDATE camera_events 
SET age_group_outcome = 'other' 
WHERE age_group_outcome IS NULL;

UPDATE camera_events 
SET gender_outcome = 'other' 
WHERE gender_outcome IS NULL;
```

### File Locations
- `backend/app/models/camera_event.py` - Updated with demographic columns
- `backend/app/services/csv_processor.py` - Enhanced with demographic processing
- `backend/app/api/endpoints/analytics.py` - Updated for new grouping and filtering
- `frontend/src/components/Dashboard/EventTable.tsx` - Redesigned for demographic grouping
- `frontend/src/components/ui/Select.tsx` - New react-select component for filters
- `database/migrations/add_demographic_columns.sql` - Database migration script

### Testing Requirements
- Unit tests for demographic data processing and null handling
- Integration tests for new grouping queries
- API endpoint tests for demographic filtering
- Frontend component tests for new EventTable design
- Performance tests for demographic-based queries

### Technical Constraints
- Must handle null/undefined demographic values as "other"
- Should group by 1-hour time intervals accurately
- Must maintain existing dwell time calculation logic
- Should provide fast queries for demographic filtering
- Must support react-select components for dropdown filters
- Should handle timezone conversion for time period grouping

### Architecture References
- [Source: docs/architecture/3-data-flow-processing-pipeline-current-future.md#Current (v0.1)]
- [Source: docs/architecture/5-backend-data-processing-details.md]
- [Source: docs/architecture/7-database-schema-storage-design-high-level.md]

## Testing
- Unit tests for demographic data processing and null handling
- Integration tests for new grouping queries and filtering
- API endpoint tests for demographic analytics
- Frontend component tests for new EventTable design
- Performance tests for demographic-based queries

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Initial story creation | SM |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- Database schema updated with demographic columns (age_group_outcome, gender_outcome)
- CSV processor enhanced with demographic data processing and null/undefined to "other" mapping
- Backend API enhanced with new demographic grouping endpoints and time period calculations
- EventTable component redesigned for demographic grouping with enhanced filtering

### Completion Notes List
- Task 1: Database Schema Updates - Added demographic columns and indexes to camera_events table
- Task 2: CSV Processing Enhancement - Enhanced CSV processor to handle demographic data with null mapping
- Task 3: Backend API Enhancement - Updated events endpoint for new grouping structure and added demographic analytics endpoints
- Task 4: EventTable Component Redesign - Redesigned table for demographic grouping with time periods and enhanced filtering
- Task 5: Enhanced Search and Filtering - Implemented comprehensive filtering with dropdowns for demographics and time periods
- Task 6: Analytics Integration - Enhanced analytics service with demographic-based queries and updated KPI cards for demographic insights

### File List
- backend/app/models/camera_events.py - Updated with demographic columns and indexes
- backend/app/services/csv_processor.py - Enhanced with demographic data processing
- backend/app/api/analytics.py - Added demographic analytics endpoints and enhanced events endpoint
- frontend/src/components/Dashboard/EventTable.tsx - Redesigned for demographic grouping
- backend/alembic/versions/add_demographic_columns_migration.py - Database migration for demographic columns
- backend/app/services/analytics_service.py - Enhanced with demographic-based analytics methods
- frontend/src/components/Dashboard/KPICards.tsx - Updated with demographic insights cards
- frontend/src/components/Dashboard/Dashboard.tsx - Enhanced to fetch and display demographic analytics 