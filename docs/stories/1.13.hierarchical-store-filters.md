# Story 1.13: Hierarchical Filters (Division → Department → Store → Camera)

## Status
Ready for Review

## Story
**As a** dashboard user,
**I want to** filter all analytics (KPIs and charts) using a clear hierarchy of organizational metadata,
**so that** I can drill down from Division to Department, then to Store and finally to Camera without seeing irrelevant options.

## Domain Mapping (DB → UI)
- Division → `camera_events.division`
- Department (part of Division) → `camera_events.department`
- Store (part of Department) → `camera_events.camera_group`
- Camera (part of Store) → `camera_events.camera_description`

## Acceptance Criteria
1. **Cascading behavior**
   - Selecting a Division filters Departments list.
   - Selecting a Department filters Stores list.
   - Selecting a Store filters Cameras list.
   - Clearing a higher-level selection resets all lower levels.
   - Each level supports an "All" option (default) meaning no constraint at that level.
2. **Apply to data**
   - KPIs (Total Visitors, Avg Dwell Time, Active Cameras) and all charts (Dwell Time, Foot Traffic, Waiting Time) must accept and apply the four filter params.
3. **UX**
   - Four dropdowns in order: Division → Department → Store → Camera.
   - Disabled state while options load, with skeletons.
   - Searchable dropdowns; options show counts (optional, future).
4. **Performance**
   - Distinct lists powered by indexed columns; round‑trips are debounced.
   - Endpoints return at most 500 distinct items per level (server cap), with prefix search.
5. **Compatibility**
   - Works if some columns are NULL; lists exclude NULL unless "All".

## Backend Tasks
- [ ] Create filter endpoints (FastAPI):
  - [ ] `GET /api/v1/analytics/filters/divisions?search=`
  - [ ] `GET /api/v1/analytics/filters/departments?division=&search=`
  - [ ] `GET /api/v1/analytics/filters/stores?division=&department=&search=`
  - [ ] `GET /api/v1/analytics/filters/cameras?division=&department=&store=&search=`
  - [ ] Shared response shape:
    ```json
    { "items": ["MAP Fashion", "Beauty"], "total": 2 }
    ```
- [ ] Accept the four optional params on analytics endpoints and apply WHERE clauses.
- [ ] Use existing indexes: `idx_division`, `idx_department`, `idx_group_dept_div`, `idx_camera_description_filter`.
- [ ] SQL patterns (PostgreSQL examples):
  ```sql
  -- divisions
  SELECT DISTINCT division
  FROM camera_events
  WHERE division IS NOT NULL
    AND ($1 IS NULL OR division ILIKE $1||'%')
  ORDER BY division
  LIMIT 500;

  -- departments within a division
  SELECT DISTINCT department
  FROM camera_events
  WHERE department IS NOT NULL
    AND ($1 IS NULL OR division = $1)
    AND ($2 IS NULL OR department ILIKE $2||'%')
  ORDER BY department
  LIMIT 500;

  -- stores within dept
  SELECT DISTINCT camera_group
  FROM camera_events
  WHERE camera_group IS NOT NULL
    AND ($1 IS NULL OR division = $1)
    AND ($2 IS NULL OR department = $2)
    AND ($3 IS NULL OR camera_group ILIKE $3||'%')
  ORDER BY camera_group
  LIMIT 500;

  -- cameras within store
  SELECT DISTINCT camera_description
  FROM camera_events
  WHERE camera_description IS NOT NULL
    AND ($1 IS NULL OR division = $1)
    AND ($2 IS NULL OR department = $2)
    AND ($3 IS NULL OR camera_group = $3)
    AND ($4 IS NULL OR camera_description ILIKE $4||'%')
  ORDER BY camera_description
  LIMIT 500;
  ```

## Frontend Tasks
- [ ] Create `HierarchyFilters` component (Ant Design Select or shadcn/ui Select):
  - Props: `division`, `department`, `store`, `camera`, `onChange`, `loadingStates`.
  - Calls the filter endpoints; cascades selection; debounced search.
  - Renders in Dashboard above KPIs (next to Apply button) and is reused on Analytics pages.
- [ ] Wire selections into existing data fetchers (KPIs/charts) by adding params:
  `?division=&department=&store=&camera=`.
- [ ] Preserve selection in URL query params and localStorage (optional).
- [ ] Disable lower selects when higher selections are empty; reset values when parent changes.

## API Contract Changes (Non‑breaking)
- Analytics endpoints (`/kpi-metrics`, `/dwell-time-analytics`, `/foot-traffic-data`, `/waiting-time`) accept the four optional query params and apply them.

## Testing
- Unit: reducers/state for `HierarchyFilters`; rendering and disabled/clear logic.
- Integration: filter endpoints return expected lists given seeded data.
- E2E: applying combinations updates KPIs and both charts; clearing resets correctly.

## Notes
- "Store" equals `camera_group` in DB.
- The specified hierarchy is authoritative: **Division → Department → Store → Camera**.
- Keep round‑trips small; prefetch next-level options after a selection if network allows.

## Change Log
| Date       | Version | Description                         | Author |
|------------|---------|-------------------------------------|--------|
| 2025-01-30 | 1.0     | Initial story with full hierarchy   | SM     |
