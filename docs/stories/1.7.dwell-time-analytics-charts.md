# Story 1.7: Dwell Time Analytics Charts

## Status
Ready for Review

## Story
**As a** user of the Dwell-Insight analytics platform,
**I want to** view beautiful dwell time analytics charts with demographic breakdowns and time period filtering,
**so that** I can analyze dwell time patterns across different age groups, genders, and time periods.

## Acceptance Criteria
1. **Chart Implementation:**
   - [x] Implement horizontal bar chart for "Average Dwell Time (Hour)" by gender
   - [x] Implement line chart for "Average Dwell Time per Week (Hour) by Age and Gender"
   - [x] Use Chart.js library for beautiful, responsive charts
   - [x] Support both total dwell time (count) and average dwell time metrics
   - [x] Display data for Male, Female, and Other gender categories

2. **Time Period Filtering:**
   - [x] Add dropdown filter for time periods: Day, Week, Monthly, Quarterly, Yearly
   - [x] Chart reloads automatically when time period is selected
   - [x] Filter data based on selected time period

3. **Date/Period Selection:**
   - [x] When "day" is selected → show date picker (default: today)
   - [x] When "week" is selected → show week picker (default: current week)
   - [x] When "month" is selected → show month picker (default: current month)
   - [x] When "quarter" is selected → show quarter picker (default: current quarter)
   - [x] When "year" is selected → show year picker (default: current year)
   - [x] Date/period picker appears below existing filters for good UX flow
   - [x] Selected date/period displays as readable text (e.g., "March 15, 2024" or "Q1 2024")
   - [x] Use react-datepicker library for consistent, accessible date selection
   - [x] Maintain existing filter styling and layout consistency

4. **Demographic Data Visualization:**
   - [x] X-axis: Age groups (20-29, 30-39, 40-49, 50-59, Other)
   - [x] Y-axis: Dwell time (total duration or average duration)
   - [x] Series: Gender (Male, Female, Other) with distinct colors

5. **Chart Interactivity:**
   - [x] Hover tooltips showing exact values
   - [x] Responsive design for different screen sizes
   - [x] Smooth animations and transitions

## Tasks / Subtasks
- [x] **Task 1: Chart.js Setup (AC: 1)**
  - [x] Install and configure Chart.js library
  - [x] Set up chart container components
  - [x] Configure chart themes and styling

- [x] **Task 2: Bar Chart Implementation (AC: 1)**
  - [x] Create horizontal bar chart for average dwell time by gender
  - [x] Implement data formatting for gender categories
  - [x] Add chart title and axis labels

- [x] **Task 3: Line Chart Implementation (AC: 1)**
  - [x] Create line chart for average dwell time by age and gender
  - [x] Implement data formatting for age groups
  - [x] Add multiple series for different genders

- [x] **Task 4: Time Period Filtering (AC: 2)**
  - [x] Create dropdown for time period selection
  - [x] Implement time period filtering logic
  - [x] Add chart reload functionality

- [x] **Task 5: Metric Type Filtering (AC: 1)**
  - [x] Add dropdown for metric selection (Total vs Average)
  - [x] Implement data aggregation logic
  - [x] Update chart Y-axis labels

- [x] **Task 6: Backend API Development (AC: 3)**
  - [x] Create analytics endpoint for chart data
  - [x] Implement SQL aggregation queries
  - [x] Add time period filtering in queries

- [x] **Task 7: Date/Period Selection Implementation (AC: 3)**
  - [x] Install react-datepicker library and types
  - [x] Extend ChartFiltersProps interface with selectedDate and onDateChange
  - [x] Implement conditional date picker rendering based on timePeriod
  - [x] Add different picker types (date, week, month, quarter, year)
  - [x] Handle date formatting for different period types
  - [x] Update parent component to handle date selection
  - [x] Add proper error handling for invalid dates
  - [x] Test all time period combinations

## Dev Notes

### Data Models
**Chart Data Interface:**
```typescript
interface ChartDataPoint {
  age_group: string; // "20-29", "30-39", "40-49", "50-59", "other"
  gender: string; // "male", "female", "other"
  total_dwell_time: number; // in seconds
  avg_dwell_time: number; // in seconds
  event_count: number;
}
```

**Camera Events Schema (Key Columns):**
- `age_group_outcome` (VARCHAR(50), nullable)
- `gender_outcome` (VARCHAR(20), nullable)
- `dwell_time` (integer, calculated)
- `utc_time_started_readable` (timestamp)
- `utc_time_ended_readable` (timestamp)
- `created_at` (timestamp with time zone)

### API Specifications
**Chart Data Endpoint:**
- `GET /api/v1/analytics/chart-data`
- Query parameters: time_period, metric_type, chart_type
- Returns aggregated data for chart visualization

### Component Specifications
**Chart Components:**
- Location: `frontend/src/components/Dashboard/Charts/`
- Components: DwellTimeBarChart, DwellTimeLineChart, ChartFilters
- Props: `data: ChartDataPoint[]`, `config: ChartConfig`

**ChartFilters Component Updates:**
- Add new props: `selectedDate: Date | null`, `onDateChange: (date: Date | null) => void`
- Implement conditional date picker based on timePeriod selection
- Use react-datepicker for consistent date selection experience
- Handle different date formats for different period types:
  - Day: "March 15, 2024"
  - Week: "Week of March 11-17, 2024" 
  - Month: "March 2024"
  - Quarter: "Q1 2024"
  - Year: "2024"

### File Locations
- `frontend/src/components/Dashboard/Charts/DwellTimeBarChart.tsx`
- `frontend/src/components/Dashboard/Charts/DwellTimeLineChart.tsx`
- `frontend/src/components/Dashboard/Charts/ChartFilters.tsx`
- `backend/app/api/endpoints/analytics.py`
- `backend/app/services/chart_aggregator.py`

### Technical Constraints
- Must use Chart.js library
- Should handle large datasets efficiently
- Must support responsive design
- Should provide smooth animations
- Must handle null/undefined as "Other"
- Must use react-datepicker for date selection
- Should maintain existing filter styling and layout
- Must handle different date formats for different time periods

## Testing
- Unit tests for chart data aggregation
- Integration tests for chart API endpoints
- Frontend component tests for chart rendering
- Performance tests for large datasets

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Initial story creation | SM |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- None yet

### Completion Notes List
- Task 1 completed: Chart.js library installed and configured with react-chartjs-2
- Created chart theme configuration with color palette for gender categories
- Implemented DwellTimeBarChart component with horizontal bar chart for gender analytics
- Implemented DwellTimeLineChart component for age and gender analytics
- Created ChartFilters component for time period and metric type selection
- Updated Dashboard component to include new Charts tab with chart components
- Added chart data fetching logic with filter support
- Task 2-5 completed: All chart components and filtering functionality implemented
- Task 6 completed: Backend API endpoint `/api/v1/analytics/chart-data` created with SQL aggregation queries
- Task 7 completed: Date/period selection implementation with react-datepicker library
- Added conditional date picker rendering based on time period selection
- Implemented date formatting for different period types (day, week, month, quarter, year)
- Updated Dashboard component to handle date selection and API integration
- All acceptance criteria met: charts, filtering, interactivity, responsive design, and date selection implemented

### File List
- frontend/src/components/Dashboard/Charts/index.ts
- frontend/src/components/Dashboard/Charts/DwellTimeBarChart.tsx
- frontend/src/components/Dashboard/Charts/DwellTimeLineChart.tsx
- frontend/src/components/Dashboard/Charts/ChartFilters.tsx (updated with date picker)
- frontend/src/components/Dashboard/Dashboard.tsx (updated with date selection)
- backend/app/api/analytics.py (updated with chart-data endpoint)
- package.json (updated with react-datepicker dependency) 