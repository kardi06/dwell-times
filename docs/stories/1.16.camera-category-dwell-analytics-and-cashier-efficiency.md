# Story 1.16: Camera Category Dwell Analytics + Cashier Efficiency Section

## Status
Approved

## Goal
- Split cameras by category and change dwell analytics behavior:
  - General Dwell Analytics (all existing dwell-time charts and KPI usage) MUST exclude cashier cameras by default and only use Entrance + Store cameras.
  - A new Dashboard section “Cashier Efficiency” MUST show the same dwell-time analytics concept but ONLY for cashier cameras.
- Simplify camera selection for general dwell charts to a category selector: All Cameras (Entrance+Store), Entrance Cameras, Store Cameras.

## In-Scope Files
- Backend
  - `backend/app/api/analytics/dwell_time_analytics.py`
- Frontend
  - `frontend/src/components/Dashboard/Charts/DwellTimeBarChart.tsx`
  - `frontend/src/components/Dashboard/Charts/DwellTimeLineChart.tsx`
  - `frontend/src/components/Dashboard/Charts/DwellTimeTimeChart.tsx`
  - `frontend/src/components/Dashboard/Dashboard.tsx`
  - `frontend/src/hooks/useDwellTimeTimeSeries.ts`
  - `frontend/src/components/Dashboard/Charts/ChartFilters.tsx`

## Camera Categories (derived at query-time)
- Category is determined from camera fields; no DB schema change required.
- Classification function (server-side):
  - cashier: if `camera_description` or `zone_name` contains any of (case-insensitive) ["cashier", "kasir", "checkout", "till", "payment", "counter"]
  - entrance: keywords ["entrance", "entry", "front door", "gate"]
  - store: default when neither cashier nor entrance
- Provide an override hook (config map) if needed later; not required in this story.

## Acceptance Criteria
1. General Dwell Analytics (all existing dwell charts and their APIs) exclude cashier cameras by default.
2. Chart-level filter changes:
   - Replace specific camera dropdown with a **Camera Category** select containing:
     - All Cameras (Entrance + Store) – default
     - Entrance Cameras
     - Store Cameras
   - No per-camera freeform selection for general dwell charts in this story.
3. New Dashboard section: **Cashier Efficiency**
   - Uses dwell-time series chart UI (reuse `DwellTimeTimeChart`), but queries ONLY cashier cameras.
   - Includes view type (hourly/daily) and metric type (average/total minutes) local filters.
   - Clear subtitle: “Cashier cameras only (dwell minutes)”.
4. Global filters (department, store, time period + date) continue to apply to both general and cashier sections.
5. Units and labels remain minutes (consistent with current charts); tooltips updated accordingly.
6. Loading skeletons and accessibility maintained; mobile-friendly layout.

## Backend Tasks
- [ ] Add optional query param `camera_category` to dwell endpoints:
  - `GET /api/v1/analytics/dwell-time-time-series` → `camera_category` in ["all", "entrance", "store", "cashier"].
  - Default behavior when `camera_category` is omitted: treat as `all` for general endpoints, BUT enforce exclusion of cashier by applying category IN (entrance, store). (See implementation note.)
- [ ] Implement classification in `dwell_time_analytics.py`:
  - Small helper to evaluate category from `camera_description`/`zone_name` using keyword lists.
  - Build a per-request in-memory cache `dict[(desc, zone)] -> category` to avoid recomputation.
- [ ] Query filter logic:
  - General dwell endpoints: if `camera_category` not provided, auto-filter to categories in (entrance, store).
  - If provided, filter accordingly (e.g., `cashier`).
- [ ] Option A (single endpoint): Reuse `/dwell-time-time-series` and pass `camera_category=cashier` for cashier section.
  - Option B (extra endpoint): `/cashier-dwell-time-series` that wraps A with enforced category; only one approach is required—pick A for simplicity.
- [ ] Logging: include `camera_category` in returned `parameters` for visibility.
- [ ] Unit tests for classification and where-clause assembly.

## Frontend Tasks
- [ ] ChartFilters.tsx:
  - Replace Camera dropdown with **Camera Category** select: ["All Cameras", "Entrance Cameras", "Store Cameras"].
  - Surface selected category to parent via callback; default "All Cameras".
- [ ] useDwellTimeTimeSeries.ts:
  - Accept `cameraCategory?: 'all' | 'entrance' | 'store' | 'cashier'`.
  - Include `camera_category` in query string when provided.
- [ ] Dashboard.tsx:
  - Ensure Dwell Time Analytics area passes the selected category (default `all`, which excludes cashier on backend).
  - Add a new Card “Cashier Efficiency” beneath current dwell section:
    - Local controls: view type (hourly/daily) and metric type (average/total).
    - Calls `useDwellTimeTimeSeries` with `cameraCategory='cashier'`.
    - Subtitle text and tooltip clarify cashier-only data.
- [ ] Dwell charts (Bar/Line/Time) remain unchanged; they receive already-filtered data.
- [ ] UX polish: consistent spacing, clear labels, skeletons while loading, keyboard navigation.

## API Contract Examples
- General (excludes cashier by default):
  `GET /api/v1/analytics/dwell-time-time-series?view_type=hourly&metric_type=average&start_date=YYYY-MM-DD&end_date=YYYY-MM-DD&department=...&store=...`
- Filtered to entrance only:
  `GET /api/v1/analytics/dwell-time-time-series?...&camera_category=entrance`
- Cashier section:
  `GET /api/v1/analytics/dwell-time-time-series?...&camera_category=cashier`

## Testing
- Backend unit tests: classification correctness (keywords), request cache, composition of `WHERE` by category.
- Backend integration tests: results differ when cashier excluded vs included; cashier-only endpoint returns only cashier cameras.
- Frontend unit tests: ChartFilters renders category select; Dashboard renders cashier card; calls include `camera_category`.
- E2E: toggling categories updates charts; cashier section renders and respects global filters.

## Risks & Mitigations
- Misclassification: start with robust keyword set; log unknowns; allow future override map.
- Performance: per-row classification mitigated by request-level cache and pushing category inference into SQL `CASE WHEN` where feasible.

## Change Log
| Date       | Version | Description                                              | Author |
|------------|---------|----------------------------------------------------------|--------|
| 2025-01-30 | 1.0     | Initial story for camera categories + cashier efficiency | SM     |
