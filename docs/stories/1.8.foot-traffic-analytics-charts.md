# Story 1.8: Foot Traffic Analytics Charts

## Status
Ready for Review

## Story
**As a** user of the Dwell-Insight analytics platform,
**I want to** view foot traffic analytics charts showing unique visitor counts by gender over time,
**so that** I can analyze visitor patterns and traffic flow across different time periods and demographics.

## Acceptance Criteria
1. **Chart Implementation:**
   - [ ] Implement line chart for "Foot Traffic - Average No. of Person Visiting Area by Time"
   - [ ] Use Chart.js library for beautiful, responsive charts
   - [ ] Display data for Male, Female, and Other gender categories
   - [ ] Support both hourly view (10 AM - 10 PM) and daily view (Monday - Sunday)

2. **Time Period Filtering:**
   - [ ] Add dropdown filter for time periods: Day, Weekly, Monthly, Yearly
   - [ ] Chart reloads automatically when time period is selected
   - [ ] Filter data based on selected time period
   - [ ] When "Day" is selected, only show hourly view (10 AM - 10 PM)

3. **Date/Period Selection:**
   - [ ] When "day" is selected → show date picker (default: today)
   - [ ] When "week" is selected → show week picker (default: current week)
   - [ ] When "month" is selected → show month picker (default: current month)
   - [ ] When "quarter" is selected → show quarter picker (default: current quarter)
   - [ ] When "year" is selected → show year picker (default: current year)
   - [ ] Date/period picker appears below existing filters
   - [ ] Selected date/period displays as readable text
   - [ ] Use react-datepicker library for consistent date selection

4. **Camera Filtering:**
   - [ ] Add dropdown for camera selection
   - [ ] Include "All Cameras" option as default
   - [ ] List all available camera_description values
   - [ ] Filter data based on selected camera
   - [ ] Chart updates automatically when camera filter changes

5. **View Type Toggle:**
   - [ ] Add toggle between "Hourly View" and "Daily View"
   - [ ] Hourly View: X-axis shows 10 AM to 10 PM (12 hours)
   - [ ] Daily View: X-axis shows Monday to Sunday (7 days)
   - [ ] When "Day" time period is selected, disable Daily View option
   - [ ] Toggle affects chart data aggregation and display

6. **Data Visualization:**
   - [ ] X-axis: Time periods (hourly: 10 AM - 10 PM, daily: Mon - Sun)
   - [ ] Y-axis: Unique person count (based on person_id)
   - [ ] Series: Gender (Male, Female, Other) with distinct colors
   - [ ] Handle null/undefined gender values as "Other"

7. **Chart Interactivity:**
   - [ ] Hover tooltips showing exact visitor counts
   - [ ] Responsive design for different screen sizes
   - [ ] Smooth animations and transitions
   - [ ] Clear legend with gender color indicators

## Tasks / Subtasks
- [x] **Task 1: Chart.js Setup and Configuration (AC: 1)**
  - [x] Set up foot traffic chart container components
  - [x] Configure chart themes and styling for traffic visualization
  - [x] Implement responsive chart layouts

- [x] **Task 2: Foot Traffic Line Chart Implementation (AC: 1)**
  - [x] Create line chart component for foot traffic by gender
  - [x] Implement data formatting for gender categories (Male, Female, Other)
  - [x] Add chart title and axis labels
  - [x] Configure line colors (Male: blue, Female: red, Other: yellow/green)

- [x] **Task 3: Time Period Filtering (AC: 2)**
  - [x] Create dropdown for time period selection (Day, Weekly, Monthly, Yearly)
  - [x] Implement time period filtering logic
  - [x] Add chart reload functionality when filter changes
  - [x] Update chart titles based on selected time period

- [x] **Task 4: Date/Period Selection Implementation (AC: 3)**
  - [x] Install react-datepicker library (if not already done)
  - [x] Extend ChartFiltersProps interface with selectedDate and onDateChange
  - [x] Implement conditional date picker rendering based on timePeriod
  - [x] Add different picker types (date, week, month, quarter, year)
  - [x] Handle date formatting for different period types
  - [x] Update parent component to handle date selection
  - [x] Add proper error handling for invalid dates

- [x] **Task 5: Camera Filtering (AC: 4)**
  - [x] Create dropdown for camera selection
  - [x] Fetch available camera_description values from database
  - [x] Implement camera filtering logic
  - [x] Add "All Cameras" option as default
  - [x] Update chart data when camera filter changes

- [x] **Task 6: View Type Toggle (AC: 5)**
  - [x] Create toggle component for Hourly vs Daily view
  - [x] Implement hourly view (10 AM - 10 PM, 12 hours)
  - [x] Implement daily view (Monday - Sunday, 7 days)
  - [x] Disable Daily View when "Day" time period is selected
  - [x] Update chart data aggregation based on view type

- [x] **Task 7: Backend API Development (AC: 6)**
  - [x] Create foot traffic analytics endpoint
  - [x] Implement SQL aggregation queries for unique person count
  - [x] Add time period filtering in backend queries
  - [x] Add camera filtering in backend queries
  - [x] Add view type filtering (hourly vs daily)
  - [x] Optimize queries for large datasets

- [x] **Task 8: Data Integration and Performance (AC: 7)**
  - [x] Connect frontend charts to backend API
  - [x] Implement loading states and error handling
  - [x] Add data refresh functionality
  - [x] Optimize chart rendering for large datasets
  - [x] Handle real-time updates when new data is uploaded

## Dev Notes

### Data Models
**Foot Traffic Chart Data Interface:**
```typescript
interface FootTrafficDataPoint {
  time_period: string; // "10 AM", "11 AM", ... "10 PM" or "Monday", "Tuesday", ... "Sunday"
  male_count: number; // unique person_id count for males
  female_count: number; // unique person_id count for females
  other_count: number; // unique person_id count for others
  total_count: number; // total unique person_id count
}

interface FootTrafficChartConfig {
  timePeriod: 'day' | 'weekly' | 'monthly' | 'yearly';
  selectedDate: Date | null;
  cameraFilter: string; // camera_description or "all"
  viewType: 'hourly' | 'daily';
}
```

**Camera Events Schema (Key Columns):**
- `person_id` (VARCHAR(100), NOT NULL) - for unique counting
- `gender_outcome` (VARCHAR(20), nullable) - for gender grouping
- `utc_time_started_readable` (timestamp) - for time grouping
- `utc_time_ended_readable` (timestamp) - for time validation
- `camera_description` (VARCHAR(100)) - for camera filtering

### API Specifications
**Foot Traffic Chart Data Endpoint:**
- `GET /api/v1/analytics/foot-traffic-data`
- Query parameters: time_period, selected_date, camera_filter, view_type
- Returns aggregated foot traffic data for chart visualization
- Supports filtering by time period, date, camera, and view type

**Camera List Endpoint:**
- `GET /api/v1/analytics/cameras`
- Returns list of available camera_description values
- Used for camera filter dropdown

### Component Specifications
**Chart Components:**
- Location: `frontend/src/components/Dashboard/Charts/`
- Components: FootTrafficChart, FootTrafficFilters
- Props: `data: FootTrafficDataPoint[]`, `config: FootTrafficChartConfig`

**FootTrafficFilters Component:**
- Time period dropdown (Day, Weekly, Monthly, Yearly)
- Date picker (conditional based on time period)
- Camera filter dropdown (All Cameras + specific cameras)
- View type toggle (Hourly vs Daily)
- Props: `config: FootTrafficChartConfig`, `onConfigChange: (config: FootTrafficChartConfig) => void`

### File Locations
- `frontend/src/components/Dashboard/Charts/FootTrafficChart.tsx` - Main chart component
- `frontend/src/components/Dashboard/Charts/FootTrafficFilters.tsx` - Filter components
- `frontend/src/hooks/useFootTrafficData.ts` - Custom hook for data fetching
- `backend/app/api/endpoints/analytics.py` - Foot traffic API endpoints
- `backend/app/services/foot_traffic_aggregator.py` - Foot traffic data aggregation service

### SQL Aggregation Logic
**Hourly View (10 AM - 10 PM):**
```sql
SELECT 
  EXTRACT(HOUR FROM utc_time_started_readable) as hour,
  gender_outcome,
  COUNT(DISTINCT person_id) as unique_count
FROM camera_events 
WHERE EXTRACT(HOUR FROM utc_time_started_readable) BETWEEN 10 AND 22
GROUP BY hour, gender_outcome
ORDER BY hour
```

**Daily View (Monday - Sunday):**
```sql
SELECT 
  EXTRACT(DOW FROM utc_time_started_readable) as day_of_week,
  gender_outcome,
  COUNT(DISTINCT person_id) as unique_count
FROM camera_events 
GROUP BY day_of_week, gender_outcome
ORDER BY day_of_week
```

### Technical Constraints
- Must use Chart.js library for chart implementation
- Should handle large datasets efficiently with proper data aggregation
- Must support responsive design for different screen sizes
- Should provide smooth animations and transitions
- Must handle null/undefined gender values as "Other"
- Must use react-datepicker for date selection
- Should maintain existing filter styling and layout consistency
- Must handle different date formats for different time periods
- Must count unique person_id (not total events)
- Should optimize queries for unique person counting

### Testing Requirements
- Unit tests for foot traffic data aggregation logic
- Integration tests for foot traffic API endpoints
- Frontend component tests for chart rendering and interactions
- Performance tests for large dataset chart rendering
- Visual regression tests for chart styling and responsiveness

## Testing
- Unit tests for foot traffic data aggregation
- Integration tests for foot traffic API endpoints
- Frontend component tests for chart rendering
- Performance tests for large datasets
- Visual regression tests for chart styling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Initial story creation | SM |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- Implemented foot traffic analytics charts with Chart.js
- Created FootTrafficChart component with line chart visualization
- Created FootTrafficFilters component with time period, date, camera, and view type filters
- Added backend API endpoints for foot traffic data and camera list
- Integrated foot traffic analytics into Dashboard as new tab
- Implemented custom hooks for data fetching and camera management

### Completion Notes List
- Successfully implemented all 8 tasks and subtasks
- Created responsive foot traffic line charts with gender-based data visualization
- Implemented comprehensive filtering system with time periods, dates, cameras, and view types
- Added backend API endpoints with proper SQL aggregation for unique person counting
- Integrated frontend components with backend APIs using custom hooks
- Added foot traffic analytics as a new tab in the main Dashboard
- All acceptance criteria have been met and implemented

### File List
- `frontend/src/components/Dashboard/Charts/FootTrafficChart.tsx` - Main foot traffic chart component
- `frontend/src/components/Dashboard/Charts/FootTrafficFilters.tsx` - Filter components for foot traffic
- `frontend/src/hooks/useFootTrafficData.ts` - Custom hook for foot traffic data fetching
- `frontend/src/hooks/useCameras.ts` - Custom hook for camera list fetching
- `frontend/src/components/Dashboard/FootTrafficAnalytics.tsx` - Main foot traffic analytics component
- `frontend/src/components/Dashboard/Charts/index.ts` - Updated exports
- `frontend/src/components/Dashboard/Dashboard.tsx` - Updated with foot traffic tab
- `backend/app/api/analytics.py` - Added foot traffic and camera endpoints 