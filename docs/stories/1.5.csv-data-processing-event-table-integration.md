# Story 1.5: CSV Data Processing & EventTable Integration

## Status
Ready for Review

## Story
**As a** user of the Dwell-Insight analytics platform,
**I want to** upload CSV files with camera event data and see the processed data displayed in the EventTable,
**so that** I can analyze dwell time patterns and visitor behavior from real camera data.

## Acceptance Criteria
1. **CSV Data Processing:**
   - [ ] Parse CSV files with camera event data matching the image structure
   - [ ] Extract required fields: person_id, camera_id, camera_description, zone_name, utc_time_started_readable, utc_time_ended_readable
   - [ ] Calculate dwell time as (utc_time_ended_readable - utc_time_started_readable) during upload
   - [ ] Store raw CSV data + calculated dwell_time in existing camera_events table
   - [ ] Handle data validation and error reporting for malformed CSV files

2. **Database Schema & Storage:**
   - [ ] Use existing camera_events table with dwell_time column for calculated values
   - [ ] Implement proper indexing for person_id, camera_description, dwell_time, created_at
   - [ ] Handle data type conversions (timestamps, durations) during CSV processing
   - [ ] Support bulk insert operations for large CSV files with pre-calculated dwell_time

3. **EventTable Integration:**
   - [ ] Update EventTable to display aggregated data from camera_events table
   - [ ] Show grouped data: person_id, camera_description, total_dwell_time, event_count, created_at
   - [ ] Implement sorting by all columns with fast queries using pre-calculated dwell_time
   - [ ] Add filtering by camera_description and zone_name
   - [ ] Update search functionality to work with grouped data structure
   - [ ] Update CSV export to include aggregated columns

4. **Analytics & Aggregation:**
   - [ ] Use SQL GROUP BY to aggregate dwell time data by person_id and camera_description
   - [ ] Calculate total_dwell_time, avg_dwell_time, event_count per person per camera
   - [ ] Display aggregated statistics in KPI cards using pre-calculated values
   - [ ] Support filtering and grouping in EventTable with optimized queries

5. **Performance & Error Handling:**
   - [ ] Handle large CSV files efficiently with progress tracking and pre-calculated dwell_time
   - [ ] Implement proper error handling for data processing failures
   - [ ] Add loading states during data processing and fast query responses
   - [ ] Optimize database queries using indexes on person_id, camera_description, dwell_time

## Tasks / Subtasks
- [x] **Task 1: Database Schema Optimization (AC: 2)**
  - [x] Verify existing camera_events table structure and dwell_time column
  - [x] Add indexes for person_id, camera_description, dwell_time, created_at for fast queries
  - [x] Optimize existing indexes for GROUP BY queries
  - [x] Add database constraints for data integrity

- [x] **Task 2: CSV Processing Engine (AC: 1)**
  - [x] Create CSV parser for the specific data structure from image
  - [x] Implement dwell time calculation: utc_time_ended_readable - utc_time_started_readable
  - [x] Add data validation for required fields and timestamp formats
  - [x] Handle timestamp parsing and conversion to proper format
  - [x] Implement bulk insert operations with pre-calculated dwell_time

- [x] **Task 3: Backend API Development (AC: 1, 2)**
  - [x] Create CSV upload endpoint with dwell time calculation during processing
  - [x] Create aggregated events endpoint with GROUP BY person_id, camera_description
  - [x] Add analytics endpoints for KPI calculations using pre-calculated dwell_time
  - [x] Implement error handling and validation for CSV processing
  - [x] Add progress tracking for large file uploads with calculation status

- [x] **Task 4: EventTable Component Update (AC: 3)**
  - [x] Update CameraEvent interface to match aggregated data structure
  - [x] Modify table columns to display: person_id, camera_description, total_dwell_time, event_count, created_at
  - [x] Update sorting and filtering logic for grouped data
  - [x] Enhance search functionality for person_id and camera_description
  - [x] Update CSV export functionality for aggregated data

- [x] **Task 5: Analytics Integration (AC: 4)**
  - [x] Create SQL GROUP BY queries for person_id and camera_description aggregation
  - [x] Update KPI cards to show total_dwell_time, avg_dwell_time, event_count using pre-calculated values
  - [x] Add analytics endpoints for dashboard integration with fast queries
  - [x] Implement caching for performance optimization of aggregated data

- [x] **Task 6: Error Handling & Performance (AC: 5)**
  - [x] Add comprehensive error handling for CSV processing and dwell time calculation
  - [x] Implement progress tracking for large file uploads with calculation status
  - [x] Add loading states and user feedback for fast query responses
  - [x] Optimize database queries using indexes on person_id, camera_description, dwell_time
  - [x] Add data validation and quality checks for timestamp formats

## Dev Notes

### Previous Story Insights
- Story 1.2 (Data Processing & Analytics Engine) provides the foundation for CSV processing
- Story 1.3 (MVP Core Analytics Dashboard) shows the current EventTable implementation
- Story 1.4 (UI Enhancement) has modernized the UI components with Tailwind CSS
- Current EventTable uses mock data and needs to be connected to real backend

### Data Models
**CameraEvent Interface (Updated for Aggregated View):**
```typescript
interface CameraEvent {
  person_id: string;
  camera_description: string;
  total_dwell_time: number; // in seconds, pre-calculated
  avg_dwell_time: number; // in seconds, pre-calculated
  event_count: number; // number of events for this person/camera
  created_at: string; // ISO timestamp of latest event
}
```

**CSV Data Structure (from image):**
- person_id: string (e.g., "client-29b-efd4-f7b-738-b970093eb")
- camera_id: string (e.g., "961db544-5f2f-4d12-8087-a5b22c7183")
- camera_description: string (e.g., "Video 1")
- zone_name: string (e.g., "Cashier queue")
- utc_time_started_readable: string (e.g., "7/28/2025 10:00")
- utc_time_ended_readable: string (e.g., "7/28/2025 10:00")

**Dwell Time Calculation:**
- Formula: `dwell_time = utc_time_ended_readable - utc_time_started_readable`
- Calculated during CSV upload and stored in `dwell_time` column
- Used for fast queries and aggregations

### API Specifications
**CSV Upload Endpoint:**
- `POST /api/v1/analytics/upload-csv`
- Accepts multipart form data with CSV file
- Returns processing status and validation results
- Handles large files with progress tracking

**Events Retrieval Endpoint:**
- `GET /api/v1/analytics/events`
- Query parameters: page, limit, search, camera_filter, zone_filter
- Returns aggregated events grouped by person_id and camera_description
- Supports sorting by total_dwell_time, avg_dwell_time, event_count

**Analytics Endpoint:**
- `GET /api/v1/analytics/aggregated-dwell-time`
- Query parameters: group_by (person_id, camera_description)
- Returns aggregated dwell time statistics using pre-calculated dwell_time values
- Fast queries using database indexes on person_id, camera_description, dwell_time

### Component Specifications
**EventTable Component Updates:**
- Location: `frontend/src/components/Dashboard/EventTable.tsx`
- Props: `token: string`
- Aggregated columns: person_id, camera_description, total_dwell_time, avg_dwell_time, event_count, created_at
- Enhanced filtering by camera_description
- Updated sorting for aggregated columns with fast queries
- Improved search for person_id and camera_description

**FileUpload Component Integration:**
- Location: `frontend/src/components/FileUpload/FileUpload.tsx`
- Enhanced to handle CSV processing feedback with dwell time calculation status
- Progress tracking for large file uploads with calculation progress
- Error handling for malformed CSV files and calculation errors

### File Locations
- `backend/app/models/camera_event.py` - Database model for existing camera_events table
- `backend/app/services/csv_processor.py` - CSV processing service with dwell time calculation
- `backend/app/api/endpoints/analytics.py` - Analytics API endpoints with GROUP BY queries
- `frontend/src/components/Dashboard/EventTable.tsx` - Updated EventTable component for aggregated data
- `frontend/src/components/FileUpload/FileUpload.tsx` - Enhanced file upload component with calculation feedback
- `database/indexes/` - Database index optimization scripts

### Testing Requirements
- Unit tests for CSV parsing and dwell time calculation
- Integration tests for database operations
- API endpoint tests for upload and retrieval
- Frontend component tests for EventTable updates
- Performance tests for large CSV file processing

### Technical Constraints
- Must handle CSV files up to 100MB efficiently with pre-calculated dwell_time
- Should process dwell time calculations accurately during upload
- Must maintain data integrity during bulk operations with existing table structure
- Should provide real-time feedback during processing with calculation status
- Must support concurrent uploads without conflicts using database transactions
- Must use existing camera_events table structure with dwell_time column

### Architecture References
- [Source: docs/architecture/3-data-flow-processing-pipeline-current-future.md#Current (v0.1)]
- [Source: docs/architecture/5-backend-data-processing-details.md]
- [Source: docs/architecture/7-database-schema-storage-design-high-level.md]

## Testing
- Unit tests for CSV parsing and dwell time calculation
- Integration tests for database operations and API endpoints
- Frontend component tests for EventTable functionality
- Performance tests for large file processing
- Data validation tests for various CSV formats

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-29 | 1.0 | Initial story creation | SM |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- Updated database schema with dwell_time, camera_description, and zone_name columns
- Added optimized indexes for GROUP BY queries and analytics
- Enhanced CSV processor with dwell time calculation during upload
- Created new API endpoints for aggregated events and analytics
- Updated EventTable component for aggregated data display
- Enhanced FileUpload component with processing feedback

### Completion Notes List
- **Task 1**: Updated camera_events model with new columns and optimized indexes for fast GROUP BY queries
- **Task 2**: Enhanced CSV processor to calculate dwell time from utc_time_started_readable and utc_time_ended_readable during upload
- **Task 3**: Added new API endpoints: /events for aggregated data and /aggregated-dwell-time for analytics
- **Task 4**: Completely updated EventTable interface and display to show aggregated data with total_dwell_time, avg_dwell_time, event_count
- **Task 5**: Implemented SQL GROUP BY queries for analytics with pre-calculated dwell_time values
- **Task 6**: Added comprehensive error handling and progress tracking for CSV processing with dwell time calculation feedback

### File List
- `backend/app/models/camera_events.py` - Updated with dwell_time, camera_description, zone_name columns and optimized indexes
- `backend/alembic/versions/add_dwell_time_and_analytics_columns.py` - New migration for schema updates
- `backend/app/services/csv_processor.py` - Enhanced with dwell time calculation and new field handling
- `backend/app/api/analytics.py` - Added new endpoints for aggregated events and analytics
- `frontend/src/components/Dashboard/EventTable.tsx` - Updated for aggregated data display
- `frontend/src/components/FileUpload/FileUpload.tsx` - Enhanced with processing feedback 